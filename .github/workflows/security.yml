name: Security Checks

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: "0 2 * * 1" # Run weekly on Mondays at 2 AM UTC

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.x

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run dependency security audit
        run: pnpm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for common security issues
        run: |
          echo "Checking for common security issues..."

          # Check for hardcoded secrets/passwords
          echo "Checking for potential hardcoded secrets..."
          if grep -r -i "password\s*=\s*['\"]" src/ --exclude-dir=node_modules || \
             grep -r -i "secret\s*=\s*['\"]" src/ --exclude-dir=node_modules || \
             grep -r -i "api_key\s*=\s*['\"]" src/ --exclude-dir=node_modules; then
            echo "WARNING: Potential hardcoded secrets found!"
            echo "Please review and use environment variables instead."
            exit 1
          else
            echo "PASS: No hardcoded secrets detected"
          fi

          # Check for console.log in production code (already handled in our standardization)
          echo "Checking for debug statements..."
          if find src/ -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | \
             xargs grep -l "console\.log" | grep -v "__test__" | grep -v ".test."; then
            echo "INFO: Found console.log statements (these should be removed before production)"
          else
            echo "PASS: No debug statements found"
          fi

          # Check for TODO security items
          echo "Checking for security TODOs..."
          if grep -r -i "TODO.*security\|FIXME.*security\|TODO.*auth\|FIXME.*auth" src/ --exclude-dir=node_modules; then
            echo "INFO: Found security-related TODOs - please address these"
          else
            echo "PASS: No security TODOs found"
          fi

      - name: Build verification (security perspective)
        run: pnpm build
        env:
          NODE_ENV: production

      - name: Security summary
        run: |
          echo "Security Check Summary:"
          echo "PASS: Dependency audit completed"
          echo "PASS: Hardcoded secrets check completed"
          echo "PASS: Debug statements check completed"
          echo "PASS: Security TODOs check completed"
          echo "PASS: Production build verification completed"
          echo ""
          echo "Security recommendations:"
          echo "1. Regularly update dependencies"
          echo "2. Use environment variables for all secrets"
          echo "3. Enable GitHub Dependabot alerts"
          echo "4. Consider adding rate limiting to API routes"
          echo "5. Implement proper input validation"

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.x

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check for new vulnerabilities
        run: |
          echo "Checking for dependency vulnerabilities..."

          # Run audit and capture output
          if pnpm audit --json > audit-results.json 2>/dev/null; then
            echo "PASS: No vulnerabilities found in dependencies"
          else
            echo "WARNING: Vulnerabilities detected. Running detailed audit..."
            
            # Show human-readable audit results
            pnpm audit || true
            
            # Check severity levels
            HIGH_COUNT=$(cat audit-results.json 2>/dev/null | jq '.metadata.vulnerabilities.high // 0' || echo "0")
            CRITICAL_COUNT=$(cat audit-results.json 2>/dev/null | jq '.metadata.vulnerabilities.critical // 0' || echo "0")
            
            echo "Critical vulnerabilities: $CRITICAL_COUNT"
            echo "High vulnerabilities: $HIGH_COUNT"
            
            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "FAIL: Critical vulnerabilities found. Please fix before merging."
              exit 1
            elif [ "$HIGH_COUNT" -gt 0 ]; then
              echo "WARNING: High severity vulnerabilities found. Consider fixing these."
              # Don't fail the build for high severity, just warn
            fi
          fi

      - name: Check for package-lock changes
        if: github.event_name == 'pull_request'
        run: |
          echo "Checking for dependency changes in this PR..."

          # Get the base branch
          git fetch origin ${{ github.base_ref }}

          # Compare package.json and pnpm-lock.yaml
          if git diff origin/${{ github.base_ref }}...HEAD --name-only | grep -E "(package\.json|pnpm-lock\.yaml)"; then
            echo "INFO: Dependencies were modified in this PR:"
            echo ""
            echo "Modified files:"
            git diff origin/${{ github.base_ref }}...HEAD --name-only | grep -E "(package\.json|pnpm-lock\.yaml)" || true
            echo ""
            echo "Package.json changes:"
            git diff origin/${{ github.base_ref }}...HEAD -- package.json || echo "No package.json changes"
            echo ""
            echo "WARNING: Please ensure all new dependencies are necessary and from trusted sources."
          else
            echo "PASS: No dependency changes detected in this PR"
          fi
